# Written by: Esha Joshi
# Description: Combines benchmark TSVs generated by Snakemake into one file
# and appends the rule name and process name for plotting

# load in required libraries
library(tidyverse)

# explicitly specify column types to avoid errors when coercing rows
col.types <- cols(
  s = col_double(),
  `h:m:s` = col_time(format = ""),
  max_rss = col_double(),
  max_vms = col_double(),
  max_uss = col_double(),
  max_pss = col_double(),
  io_in = col_double(),
  io_out = col_double(),
  mean_load = col_double(),
  cpu_time = col_double()
)
# function to read tsv input and append rule name and process
read_benchmarks <- function(filename) {
  read_tsv(filename, col_types=col.types) %>%
    mutate(
      process = gsub("*.tsv","",basename(filename)),
      rule =  basename(dirname(filename))
      )
}

# run function for all specified snakemake inputs and output benchmarks tsv
dataset <- snakemake@input[["tsv"]] %>%
  lapply(read_benchmarks) %>%
  bind_rows()
head(dataset)
write_tsv(dataset, snakemake@output[['benchmarks']])
