# Written by: Esha Joshi
# Description: Combines benchmark TSVs generated by Snakemake into one file
# and appends the rule name and process name for plotting

library(tidyverse, quietly=TRUE)

#' Specify column types of the input benchmarking files from
#' psutil to avoid errors when coercing rows
col.types <- cols(
  s = col_double(),
  `h:m:s` = col_time(format = ""),
  max_rss = col_double(),
  max_vms = col_double(),
  max_uss = col_double(),
  max_pss = col_double(),
  io_in = col_double(),
  io_out = col_double(),
  mean_load = col_double(),
  cpu_time = col_double()
)

#' Function parse rule and process names from filename
#' to append to final dataset as columns.
#'
#' @param filename character vector; name of files
#' @return data.frame, with original file contents and
#' the 2 appended columns for 'rule' and 'process'
#'
read.benchmarks <- function(filename) {
  benchmark.file <- read_tsv(filename, col_types=col.types) %>%
    mutate(
      process = gsub("*.tsv","",basename(filename)),
      rule =  basename(dirname(filename))
      )
  benchmark.file
}

#' Function to concatenate all input benchmarking files into
#' one with appended columns using read.benchmarks()
#'
#' @param infiles list; list of filenames
#' @return data.frame, with benchmarking outputs for all rules
#'
create.dataset <- function(infiles) {
  stopifnot(is.vector(infiles, mode = "character"),
  length(infiles) > 1)
  df <- infiles %>% lapply(read.benchmarks) %>% bind_rows()
  df
}

#' Function to write generated dataset to TSV
#'
#' @param filename character vector; desired filename for output
#' @param dataset character vector; data.frame of benchmarking data
#' @return TSV file
#'
create.tsv <- function(dataset, filename) {
  stopifnot(is.data.frame(dataset))
  stopifnot(is.character(filename))
  write_tsv(dataset, filename)
}
